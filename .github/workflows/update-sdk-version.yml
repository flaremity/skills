name: Update Claude Agent SDK Version

on:
  schedule:
    - cron: "0 2 * * *" # 09:00 ICT (02:00 UTC) daily
  workflow_dispatch:
    inputs:
      force:
        description: "Force update even if versions match"
        required: false
        default: false
        type: boolean

concurrency:
  group: sdk-update
  cancel-in-progress: true

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      current_version: ${{ steps.versions.outputs.current }}
      latest_version: ${{ steps.versions.outputs.latest }}
      should_update: ${{ steps.decide.outputs.should_update }}
    steps:
      - uses: actions/checkout@v4

      - name: Get current and latest versions
        id: versions
        run: |
          CURRENT=$(jq -r '.version' skills/claude-agent-sdk-ts/.claude-plugin/plugin.json)
          echo "current=${CURRENT}" >> "$GITHUB_OUTPUT"

          LATEST=$(curl -s "https://registry.npmjs.org/@anthropic-ai/claude-agent-sdk/latest" \
            | jq -r '.version // empty')
          if [ -z "${LATEST}" ]; then
            echo "::error::Failed to fetch latest version from npm"
            exit 1
          fi
          echo "latest=${LATEST}" >> "$GITHUB_OUTPUT"

          if [ "${CURRENT}" = "${LATEST}" ]; then
            echo "needs_update=false" >> "$GITHUB_OUTPUT"
            echo "::notice::SDK is up to date (v${CURRENT})"
          else
            echo "needs_update=true" >> "$GITHUB_OUTPUT"
            echo "::notice::Update available: v${CURRENT} â†’ v${LATEST}"
          fi

      - name: Check for existing PR
        id: check_pr
        if: steps.versions.outputs.needs_update == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_COUNT=$(gh pr list \
            --state open \
            --head "chore/update-sdk-${{ steps.versions.outputs.latest }}" \
            --json number --jq 'length')
          if [ "${PR_COUNT}" -gt 0 ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "::notice::PR already exists for v${{ steps.versions.outputs.latest }}"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Decide whether to proceed
        id: decide
        run: |
          NEEDS="${{ steps.versions.outputs.needs_update }}"
          EXISTS="${{ steps.check_pr.outputs.exists }}"
          FORCE="${{ inputs.force }}"
          if [ "${FORCE}" = "true" ] || { [ "${NEEDS}" = "true" ] && [ "${EXISTS}" != "true" ]; }; then
            echo "should_update=true" >> "$GITHUB_OUTPUT"
          else
            echo "should_update=false" >> "$GITHUB_OUTPUT"
          fi

  update:
    needs: check
    if: needs.check.outputs.should_update == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute SDK type diff
        id: typediff
        run: |
          TMPDIR=$(mktemp -d)
          OLD="${{ needs.check.outputs.current_version }}"
          NEW="${{ needs.check.outputs.latest_version }}"

          npm pack "@anthropic-ai/claude-agent-sdk@${OLD}" --pack-destination "$TMPDIR" 2>/dev/null
          npm pack "@anthropic-ai/claude-agent-sdk@${NEW}" --pack-destination "$TMPDIR" 2>/dev/null

          mkdir -p "$TMPDIR/old" "$TMPDIR/new"
          tar xzf "$TMPDIR"/anthropic-ai-claude-agent-sdk-${OLD}.tgz -C "$TMPDIR/old" --strip-components=1
          tar xzf "$TMPDIR"/anthropic-ai-claude-agent-sdk-${NEW}.tgz -C "$TMPDIR/new" --strip-components=1

          diff "$TMPDIR/old/sdk.d.ts" "$TMPDIR/new/sdk.d.ts" > /tmp/sdk-type-diff.txt || true
          rm -rf "$TMPDIR"

          if [ -s /tmp/sdk-type-diff.txt ]; then
            echo "has_api_changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_api_changes=false" >> "$GITHUB_OUTPUT"
          fi

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: >-
            --max-turns 100
            --model opus
            --dangerously-skip-permissions
          prompt: |
            ## Task: Update claude-agent-sdk-ts skill to v${{ needs.check.outputs.latest_version }}

            The npm package `@anthropic-ai/claude-agent-sdk` has a new version.
            - **Current version in repo:** ${{ needs.check.outputs.current_version }}
            - **Latest version on npm:** ${{ needs.check.outputs.latest_version }}
            - **API changes detected:** ${{ steps.typediff.outputs.has_api_changes }}

            ### Step 1 â€” Research what changed

            **Primary source (deterministic):** Read `/tmp/sdk-type-diff.txt` which contains a unified diff of `sdk.d.ts` between v${{ needs.check.outputs.current_version }} and v${{ needs.check.outputs.latest_version }}. This was pre-computed by `npm pack` + `diff` in a previous CI step.

            Analyze every hunk in the diff and categorize each change:
            - **New types/interfaces** (added exports)
            - **New fields on existing types** (e.g., new options, new result fields)
            - **Changed signatures** (parameter types, return types)
            - **Removed/deprecated APIs** (deleted exports, removed fields)
            - **New enum values or union members**

            Keep a structured list of all changes â€” you will need it in Step 4.

            **Secondary source (supplementary):** Try web search for human-readable release notes at https://github.com/anthropics/claude-code or npm. This may provide context about *why* changes were made. If web search fails, proceed with the diff analysis alone â€” it is complete and sufficient.

            Do NOT ask the user any questions â€” this runs unattended in CI.

            ### Step 2 â€” Update version strings (ALL 22 occurrences)

            Read each file first, then replace `${{ needs.check.outputs.current_version }}` â†’ `${{ needs.check.outputs.latest_version }}` in:

            **JSON manifests:**
            - `skills/claude-agent-sdk-ts/.claude-plugin/plugin.json` (version field)
            - `.claude-plugin/marketplace.json` (version in plugins array)

            **Markdown docs:**
            - `skills/claude-agent-sdk-ts/SKILL.md` line ~11 (package version)
            - `skills/claude-agent-sdk-ts/SKILL.md` last line (footer "SDK v...")
            - `skills/claude-agent-sdk-ts/README.md` line ~7 (SDK Version)
            - `skills/claude-agent-sdk-ts/README.md` line ~87 (credits footer)
            - `README.md` line ~12 (root readme Available Skills table)
            - `skills/claude-agent-sdk-ts/references/known-issues.md` line 3
            - `skills/claude-agent-sdk-ts/references/query-api-reference.md` line 3
            - `skills/claude-agent-sdk-ts/references/session-management.md` line 3
            - `skills/claude-agent-sdk-ts/references/mcp-servers-guide.md` line 3
            - `skills/claude-agent-sdk-ts/references/permissions-guide.md` line 3

            **Shell script:**
            - `skills/claude-agent-sdk-ts/scripts/check-versions.sh` line 8 (CURRENT=)

            **TypeScript templates (all line 3 JSDoc):**
            - `skills/claude-agent-sdk-ts/templates/basic-query.ts`
            - `skills/claude-agent-sdk-ts/templates/structured-output.ts`
            - `skills/claude-agent-sdk-ts/templates/error-handling.ts`
            - `skills/claude-agent-sdk-ts/templates/multi-agent-workflow.ts`
            - `skills/claude-agent-sdk-ts/templates/permission-control.ts`
            - `skills/claude-agent-sdk-ts/templates/custom-mcp-server.ts`
            - `skills/claude-agent-sdk-ts/templates/session-management.ts`
            - `skills/claude-agent-sdk-ts/templates/hooks-example.ts`

            **DO NOT touch these files (historical entries):**
            - `CHANGELOG.md`
            - `.github/ISSUE_TEMPLATE/bug_report.md`

            **Also update dates:**
            - `skills/claude-agent-sdk-ts/SKILL.md` line ~13: change "Last verified" date to today (YYYY-MM-DD)
            - `skills/claude-agent-sdk-ts/references/known-issues.md` line 3: change "Last updated" date to today

            ### Step 3 â€” Update Version History table

            In `skills/claude-agent-sdk-ts/SKILL.md`, find the "Version History (Recent)" table:
            - Change existing `v${{ needs.check.outputs.current_version }} | Latest stable release` to a brief description of what that version contained (or keep as-is if unknown)
            - Add a new first row: `| v${{ needs.check.outputs.latest_version }} | Latest stable release |`
            - If you found actual changelog info in Step 1, use a real description instead of "Latest stable release"

            ### Step 4 â€” Update content based on API changes

            Use the categorized change list from Step 1 and the **Change Impact Mapping** below to determine exactly which files need content updates.

            **Change Impact Mapping:**

            | SDK Change | Files to Update |
            |---|---|
            | New hook event | `SKILL.md` Â§Hooks + `templates/hooks-example.ts` |
            | New QueryOption field | `SKILL.md` Â§Options Reference + `references/query-api-reference.md` |
            | New/changed PermissionMode | `SKILL.md` Â§Permission Modes + `references/permissions-guide.md` + `templates/permission-control.ts` |
            | New QueryResult field | `SKILL.md` Â§QueryResult + `references/query-api-reference.md` |
            | New SDKMessage type | `SKILL.md` Â§SDKMessage Types + `references/query-api-reference.md` |
            | New ThinkingConfig type | `SKILL.md` Â§Options Reference + `references/query-api-reference.md` |
            | New sandbox config | `SKILL.md` Â§Sandbox Settings + `references/permissions-guide.md` |
            | Removed/deprecated API | `SKILL.md` relevant section + `references/known-issues.md` + `rules/claude-agent-sdk-ts.md` |
            | New SDK export | `SKILL.md` Â§Core API + `rules/claude-agent-sdk-ts.md` imports |

            For each change found:
            - Add documentation for new types/options with version annotation (e.g., "(v${{ needs.check.outputs.latest_version }}+)")
            - Add code examples in templates where appropriate
            - Add to rules if it becomes a best practice or anti-pattern
            - Mark deprecated/removed APIs in `references/known-issues.md`

            If `/tmp/sdk-type-diff.txt` is empty (no API changes), SKIP this step entirely. Do NOT make speculative changes.

            ### Step 5 â€” Validate

            Run:
            ```bash
            python3 -m json.tool < .claude-plugin/marketplace.json > /dev/null && echo "marketplace.json OK"
            python3 -m json.tool < skills/claude-agent-sdk-ts/.claude-plugin/plugin.json > /dev/null && echo "plugin.json OK"
            ```

            Then verify no old version remains:
            ```bash
            grep -r "${{ needs.check.outputs.current_version }}" skills/ .claude-plugin/ README.md --include="*.json" --include="*.md" --include="*.ts" --include="*.sh" | grep -v CHANGELOG.md | grep -v bug_report.md
            ```
            This should return empty (all updated).

            ### Step 6 â€” Create branch, commit, push, and open PR

            ```bash
            BRANCH="chore/update-sdk-${{ needs.check.outputs.latest_version }}"
            git checkout -b "$BRANCH"
            git add -A
            git commit -m "feat: update claude-agent-sdk-ts to v${{ needs.check.outputs.latest_version }}

            Update @anthropic-ai/claude-agent-sdk references from
            v${{ needs.check.outputs.current_version }} to v${{ needs.check.outputs.latest_version }}.

            Automated by GitHub Actions + Claude Code."
            git push origin "$BRANCH"
            ```

            Then create the PR. Build the body dynamically based on whether API changes were found:

            If API changes were found (`/tmp/sdk-type-diff.txt` is non-empty), include an `## API Changes` section listing each change categorized (New Types, New Fields, Changed Signatures, Removed/Deprecated). Otherwise state "Version bump only â€” no API changes detected."

            ```bash
            gh pr create \
              --title "feat: update claude-agent-sdk-ts to v${{ needs.check.outputs.latest_version }}" \
              --base main \
              --head "$BRANCH" \
              --body "$(cat <<'PREOF'
            ## Summary

            - Update `@anthropic-ai/claude-agent-sdk`: `${{ needs.check.outputs.current_version }}` â†’ `${{ needs.check.outputs.latest_version }}`
            - Updated version strings across all skill files (22 occurrences)
            - Updated Version History table in SKILL.md

            ## API Changes

            [Insert categorized list of API changes from sdk.d.ts diff analysis, or "Version bump only â€” no API changes detected."]

            ## Content Updates

            [List which files were updated with new content beyond version strings, or "None â€” version bump only."]

            ## Type of Change

            - [x] Improvement to existing skill

            ## Checklist

            - [x] JSON manifests are valid
            - [x] SKILL.md has required frontmatter
            - [x] plugin.json version matches marketplace.json
            - [x] All version references updated consistently
            - [x] sdk.d.ts diff reviewed for API changes
            - [x] Content updated to reflect new/changed/removed APIs

            ---
            ðŸ¤– Automated by [Claude Code](https://claude.ai/code) via GitHub Actions
            PREOF
            )"
            ```
